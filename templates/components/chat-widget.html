<!-- Modern Floating Chat Widget -->

{% macro chat_widget() %}
<div class="kira-chat-widget" id="kiraChatWidget">
    <div class="chat-toggle" id="chatToggle" onclick="toggleChat()">
        <div class="toggle-icon">
            <i class="fas fa-comments" id="chatIcon"></i>
            <i class="fas fa-times" id="closeIcon"></i>
        </div>
        <div class="notification-badge" id="notificationBadge">3</div>
    </div>
    
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <div class="chat-avatar">
                <img src="https://via.placeholder.com/40x40/00D2D3/ffffff?text=K" alt="Kira">
                <div class="status-indicator online"></div>
            </div>
            <div class="chat-info">
                <h6 class="chat-title">Kira Assistant</h6>
                <p class="chat-status">Online • Always here to help</p>
            </div>
            <div class="chat-actions">
                <button class="action-btn" onclick="minimizeChat()" title="Minimize">
                    <i class="fas fa-minus"></i>
                </button>
                <button class="action-btn" onclick="toggleChat()" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-avatar">
                    <img src="https://via.placeholder.com/32x32/00D2D3/ffffff?text=K" alt="Kira">
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        Hallo! Ich bin Kira, dein persönlicher Assistant. Wie kann ich dir heute helfen?
                    </div>
                    <div class="message-time">vor 2 Min</div>
                </div>
            </div>
            
            <div class="message user">
                <div class="message-content">
                    <div class="message-bubble">
                        Hi Kira! Kannst du mir beim Setup helfen?
                    </div>
                    <div class="message-time">vor 1 Min</div>
                </div>
                <div class="message-avatar">
                    <img src="https://via.placeholder.com/32x32/4CAF50/ffffff?text=U" alt="User">
                </div>
            </div>
            
            <div class="message bot">
                <div class="message-avatar">
                    <img src="https://via.placeholder.com/32x32/00D2D3/ffffff?text=K" alt="Kira">
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        Natürlich! Gerne helfe ich dir beim Setup. Was möchtest du konfigurieren?
                    </div>
                    <div class="message-time">gerade eben</div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">
                    <img src="https://via.placeholder.com/32x32/00D2D3/ffffff?text=K" alt="Kira">
                </div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <div class="input-container">
                <input type="text" 
                       class="chat-input" 
                       id="chatInput" 
                       placeholder="Nachricht eingeben..."
                       onkeypress="handleChatInput(event)">
                <button class="voice-btn" onclick="toggleVoiceInput()" title="Voice Input">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="send-btn" onclick="sendMessage()" title="Send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div class="quick-actions">
                <button class="quick-action" onclick="insertQuickMessage('Hilfe')">
                    <i class="fas fa-question-circle"></i>
                    Hilfe
                </button>
                <button class="quick-action" onclick="insertQuickMessage('Status')">
                    <i class="fas fa-chart-bar"></i>
                    Status
                </button>
                <button class="quick-action" onclick="insertQuickMessage('Settings')">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.kira-chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
    font-family: var(--font-family);
}

.chat-toggle {
    width: 60px;
    height: 60px;
    background: var(--kira-gradient);
    border-radius: 50%;
    box-shadow: var(--shadow-xl);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.chat-toggle:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-2xl);
}

.chat-toggle.active {
    border-radius: var(--radius-lg);
}

.toggle-icon {
    position: relative;
    color: white;
    font-size: 1.5rem;
}

.toggle-icon i {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.3s ease;
}

#closeIcon {
    opacity: 0;
    transform: translate(-50%, -50%) rotate(90deg);
}

.chat-toggle.active #chatIcon {
    opacity: 0;
    transform: translate(-50%, -50%) rotate(-90deg);
}

.chat-toggle.active #closeIcon {
    opacity: 1;
    transform: translate(-50%, -50%) rotate(0deg);
}

.notification-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: var(--kira-danger);
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 600;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.chat-window {
    position: absolute;
    bottom: 80px;
    right: 0;
    width: 380px;
    height: 500px;
    background: white;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-2xl);
    border: 1px solid var(--kira-gray-200);
    opacity: 0;
    visibility: hidden;
    transform: translateY(20px);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-window.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
}

.chat-header {
    background: var(--kira-gradient);
    color: white;
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.chat-avatar {
    position: relative;
}

.chat-avatar img {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.3);
}

.status-indicator {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
}

.status-indicator.online {
    background: var(--kira-success);
}

.chat-info {
    flex: 1;
}

.chat-title {
    margin: 0 0 2px 0;
    font-weight: 600;
    font-size: 1rem;
}

.chat-status {
    margin: 0;
    font-size: 0.8rem;
    opacity: 0.9;
}

.chat-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.action-btn {
    width: 32px;
    height: 32px;
    border: none;
    background: rgba(255, 255, 255, 0.2);
    color: white;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

.chat-messages {
    flex: 1;
    padding: var(--spacing-lg);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.message {
    display: flex;
    gap: var(--spacing-md);
    animation: slideInUp 0.3s ease;
}

.message.user {
    flex-direction: row-reverse;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-avatar img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.message-content {
    max-width: 70%;
}

.message.user .message-content {
    text-align: right;
}

.message-bubble {
    background: var(--kira-gray-100);
    padding: var(--spacing-md);
    border-radius: var(--radius-lg);
    font-size: 0.9rem;
    line-height: 1.4;
    position: relative;
}

.message.bot .message-bubble {
    background: var(--kira-primary);
    color: white;
}

.message.user .message-bubble {
    background: var(--kira-gray-200);
    color: var(--kira-gray-800);
}

.message-time {
    font-size: 0.7rem;
    color: var(--kira-gray-500);
    margin-top: var(--spacing-xs);
}

.message.user .message-time {
    text-align: right;
}

.typing-indicator {
    display: flex;
    gap: var(--spacing-md);
    align-items: center;
}

.typing-dots {
    display: flex;
    gap: 4px;
    padding: var(--spacing-md);
    background: var(--kira-gray-100);
    border-radius: var(--radius-lg);
}

.typing-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--kira-gray-400);
    animation: typingDot 1.5s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingDot {
    0%, 60%, 100% {
        transform: scale(1);
        opacity: 0.5;
    }
    30% {
        transform: scale(1.2);
        opacity: 1;
    }
}

.chat-input-area {
    border-top: 1px solid var(--kira-gray-200);
    padding: var(--spacing-lg);
}

.input-container {
    display: flex;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
}

.chat-input {
    flex: 1;
    border: 1px solid var(--kira-gray-300);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s ease;
}

.chat-input:focus {
    border-color: var(--kira-primary);
}

.voice-btn,
.send-btn {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.voice-btn {
    background: var(--kira-gray-100);
    color: var(--kira-gray-600);
}

.voice-btn:hover {
    background: var(--kira-gray-200);
}

.voice-btn.active {
    background: var(--kira-danger);
    color: white;
    animation: pulse 1s infinite;
}

.send-btn {
    background: var(--kira-primary);
    color: white;
}

.send-btn:hover {
    background: var(--kira-primary-dark);
}

.quick-actions {
    display: flex;
    gap: var(--spacing-xs);
    flex-wrap: wrap;
}

.quick-action {
    background: var(--kira-gray-100);
    border: none;
    border-radius: var(--radius-md);
    padding: var(--spacing-xs) var(--spacing-sm);
    font-size: 0.8rem;
    color: var(--kira-gray-700);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
}

.quick-action:hover {
    background: var(--kira-primary);
    color: white;
}

/* Responsive */
@media (max-width: 480px) {
    .chat-window {
        width: 320px;
        right: -20px;
    }
}
</style>

<script>
function toggleChat() {
    const widget = document.getElementById('kiraChatWidget');
    const toggle = document.getElementById('chatToggle');
    const window = document.getElementById('chatWindow');
    const badge = document.getElementById('notificationBadge');
    
    toggle.classList.toggle('active');
    window.classList.toggle('open');
    
    if (window.classList.contains('open')) {
        badge.style.display = 'none';
        document.getElementById('chatInput').focus();
    }
}

function minimizeChat() {
    toggleChat();
}

function handleChatInput(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message) {
        addMessage(message, 'user');
        input.value = '';
        
        // Simulate bot response
        setTimeout(() => {
            showTyping();
            setTimeout(() => {
                hideTyping();
                addBotResponse(message);
            }, 1500);
        }, 500);
    }
}

function addMessage(text, sender) {
    const messagesContainer = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    
    const avatarUrl = sender === 'user' ? 
        'https://via.placeholder.com/32x32/4CAF50/ffffff?text=U' : 
        'https://via.placeholder.com/32x32/00D2D3/ffffff?text=K';
    
    messageDiv.innerHTML = `
        <div class="message-avatar">
            <img src="${avatarUrl}" alt="${sender}">
        </div>
        <div class="message-content">
            <div class="message-bubble">${text}</div>
            <div class="message-time">gerade eben</div>
        </div>
    `;
    
    messagesContainer.insertBefore(messageDiv, document.getElementById('typingIndicator'));
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addBotResponse(userMessage) {
    const responses = [
        "Das ist eine interessante Frage! Lass mich das für dich herausfinden.",
        "Ich verstehe. Hier ist was ich dazu weiß:",
        "Gerne helfe ich dir dabei! Hier sind meine Empfehlungen:",
        "Das kann ich dir erklären. Hier ist die Antwort:"
    ];
    
    const response = responses[Math.floor(Math.random() * responses.length)];
    addMessage(response, 'bot');
}

function showTyping() {
    document.getElementById('typingIndicator').style.display = 'flex';
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideTyping() {
    document.getElementById('typingIndicator').style.display = 'none';
}

function toggleVoiceInput() {
    const voiceBtn = document.querySelector('.voice-btn');
    voiceBtn.classList.toggle('active');
    
    if (voiceBtn.classList.contains('active')) {
        // Start voice recognition
        console.log('🎤 Voice input started');
    } else {
        // Stop voice recognition
        console.log('🎤 Voice input stopped');
    }
}

function insertQuickMessage(text) {
    document.getElementById('chatInput').value = text;
    sendMessage();
}
</script>
{% endmacro %}